name: Deploy to Azure Kubernetes Service (AKS)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_HUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin

      - name: Build and Push Docker Image
        run: |
          docker build -t your-dockerhub-username/ram-image:latest .
          docker push your-dockerhub-username/ram-image:latest

      - name: Set up Azure CLI
        uses: azure/setup-kubectl@v3

      - name: Get AKS Credentials
        run: az aks get-credentials --resource-group rg_techdemo --name venkat-cluster --file kubeconfig.yaml

      - name: Create Kubernetes Deployment and Service
        run: |
          kubectl apply -f k8s/ram-deployment.yaml
          kubectl apply -f k8s/ram-service.yaml

      - name: Deploy with ARM Template
        uses: Azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: rg_techdemo
          template: azuredeploy.json
          parameters: azuredeploy.parameters.json repositoryUrl=https://github.com/Venkata-Ramana-Pallapati/https://github.com/Venkata-Ramana-Pallapati/demo.git
          deploymentMode: Incremental
